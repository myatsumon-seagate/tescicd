# This file is a template, and might need editing before it works on your project.
image: docker:19.03.1
services:
  - docker:19.03.1-dind

variables:
  # Please edit to your GitLab project
  REPO_NAME: registry.gitlab.com/lyvesaas/registry
  #REPOTAG: $CI_REGISTRY_IMAGE/minio-kes:$CI_COMMIT_TAG
  CURRENT: $CI_REGISTRY_IMAGE/minio-kes:$CI_COMMIT_SHORT_SHA
  #PREPOTAG: $REPO_NAME/minio-kes:$CI_COMMIT_TAG  
  PCURRENT: $REPO_NAME/minio-kes:$CI_COMMIT_SHORT_SHA
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"

# GO - Compulsory Settings
before_script:
  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
  - cd $GOPATH/src/$REPO_NAME

stages:
  - release-image
  - hotfix-image

release-image:
  only:
    - tags
  image: docker:19.03.1
  services:
    - docker:19.03.1-dind
  stage: release-image
  before_script:
    - apk update && apk add git && apk add make
  script:
    - make docker
#   This is for local project registry - require individual credentials
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker tag minio/kes:latest $CURRENT
    - docker push $CURRENT
    - docker tag minio/kes:latest $REPOTAG;
    - docker push $REPOTAG;
#   This is for lyvesaas/registry/ - Will remove in the future   
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS $CI_REGISTRY    
    - docker tag minio/kes:latest $PCURRENT
    - docker push $PCURRENT
    - docker tag minio/kes:latest $PREPOTAG;
    - docker push $PREPOTAG;

release-image:
  only:
    - /^*.hotfix.*$/
  image: docker:19.03.1
  services:
    - docker:19.03.1-dind
  stage: release-image
  before_script:
    - apk update && apk add git && apk add make
  script:
    - make docker
#   This is for local project registry - require individual credentials
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker tag minio/kes:latest $CURRENT
    - docker push $CURRENT
    #- docker tag minio/kes:latest $REPOTAG;
    #- docker push $REPOTAG;
#   This is for lyvesaas/registry/ - Will remove in the future   
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS $CI_REGISTRY    
    - docker tag minio/kes:latest $PCURRENT
    - docker push $PCURRENT
    #- docker tag minio/kes:latest $PREPOTAG;
    #- docker push $PREPOTAG;
