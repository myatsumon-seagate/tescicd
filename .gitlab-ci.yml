image: alpine

stages:
  - build

variables:
  # Use TLS https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#tls-enabled
  REPO_NAME: registry.gitlab.com/lyvesaas/registry
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"

build-ui:
  image: docker:19.03.1
  services:
    - docker:19.03.1-dind
  before_script:
    - apk update
    - apk add git && apk add make
  stage: build
  script:
    - export MARKETPLACE_CURRENT=$REPO_NAME/sumoncicd:$CI_COMMIT_SHORT_SHA
  
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS $CI_REGISTRY
    - make docker

    #   Private Project Registry - Required
    - export REPOTAG=$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
    - export HASHTAG=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

    - echo "Private Project Registry"
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker tag com.seagate/sumoncicd:latest $HASHTAG
    - docker push $HASHTAG
    - echo $HASHTAG

    - docker tag com.seagate/sumoncicd:latest $REPOTAG
    - docker push $REPOTAG
    - echo $REPOTAG

    #   Public Registry - Will be remove
    - echo "Public Registry"
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS $CI_REGISTRY
    - docker tag com.seagate/sumoncicd:latest $MARKETPLACE_CURRENT
    - docker push $MARKETPLACE_CURRENT
    - echo $MARKETPLACE_CURRENT
  only:
    - tags
